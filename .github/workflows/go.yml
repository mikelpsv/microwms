name: Go

on:
  push:
    branches: [ "master" ]      

jobs:

  build:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v3

    - name: Set up Go
      uses: actions/setup-go@v3
      with:
        go-version: 1.18

# - name: Test
#   run: go test -v ./...

    - name: build
      run: |
        apt-get install -y libcups2-dev
        mkdir builds && GOOS=linux GOARCH=amd64 go build -race -ldflags "-extldflags '-static'" -o build/mwms
      
    - name: build_front
      run: |
        cd web
        npm install npm@6.14.17
        npm run build --if-present
      
    - name: store artifact
      uses: actions/upload-artifact@v3
      with:
        name: build_data
        path: build/
        
    - name: store artifact front
      uses: actions/upload-artifact@v3
      with:
        name: build_front_data
        path: web/dist/        

  deploy:
    needs: [build]
    environment: production

    runs-on: ubuntu-latest

    env:
      SSH_KEY: ${{secrets.DEPLOY_KEY_FOR_VDS}}
      HOSTNAME: ${{secrets.HOSTNAME}}

    steps:
      - uses: actions/checkout@v3

      - name: upload artifact
        uses: actions/download-artifact@v3
        with:
          name: build_data
          path: build/

      - name: upload artifact front
        uses: actions/download-artifact@v3
        with:
          name: build_front_data
          path: web/dist/
          
      - name: Prepare key
        run: |
          set -eu
          mkdir "$HOME/.ssh"
          echo "$SSH_KEY" > "$HOME/.ssh/key"
          chmod 600 "$HOME/.ssh/key"
          rsync -e "ssh -i $HOME/.ssh/key -o StrictHostKeyChecking=no" --archive --compress --delete . $HOSTNAME:/home/mike/deploy_mwms
          ssh -i $HOME/.ssh/key -o StrictHostKeyChecking=no $HOSTNAME chmod +x deploy_mwms/build/mwms
